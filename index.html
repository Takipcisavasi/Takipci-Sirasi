<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Takip√ßi Sava≈üƒ±</title>
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#11121a" />
  <style>
    :root{
      --bg:#0b0b12;--panel:#141422;--panel2:#10101a;--line:#26263a;--muted:#a8a8b7;
      --text:#eaeaf5;--brand:#7c4dff;--chip:#1e1e2e;--chipline:#2f2f42;--accent:#6d57ff;
      --ok:#3ecf8e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px
    }
    h1{font-size:20px;margin:0}
    .badge{
      background:var(--chip);border:1px solid var(--chipline);
      border-radius:999px;padding:6px 10px;font-size:12px;color:#cfd0e6
    }
    .spacer{flex:1}
    .igbtn{
      background:#1a1b2b;border:1px solid #2a2b40;color:#cfd0ff;
      padding:8px 12px;border-radius:999px;font-weight:600
    }
    .row{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{
      background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px
    }
    .rowtop{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .muted{color:var(--muted)}
    input,select,button{
      background:var(--panel2);border:1px solid #2b2b3e;color:var(--text);
      border-radius:8px;padding:10px
    }
    button{cursor:pointer}
    .search{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f1f2f}
    th{color:#bdbddd;text-align:left;font-weight:600}
    .userCell{display:flex;align-items:center;gap:8px}
    .ava{
      width:26px;height:26px;border-radius:50%;flex:0 0 26px;object-fit:cover;
      background:#1a1a2a;border:1px solid #2a2a3c
    }
    .chip{
      background:#19192a;border:1px solid #2f2f42; color:#c9c9e6;
      font-size:12px;border-radius:999px;padding:3px 8px
    }
    .top5-row{
      display:flex;align-items:center;gap:10px;background:#151527;
      border:1px solid #25253a;border-radius:10px;padding:8px 10px
    }
    .rank{
      width:28px;height:28px;border-radius:8px;background:#26264a;color:#cbd;
      display:grid;place-items:center;font-weight:700
    }
    .cup{filter:drop-shadow(0 0 2px #0005)}
    .gold{color:#ffd54a}.silver{color:#cfd8dc}.bronze{color:#ffab7a}
    .footer{margin-top:8px;font-size:12px;color:#9aa}

    /* --- Sorgu sonucu barƒ± ve vurgu --- */
    .youbar{
      display:none;align-items:center;gap:10px;background:#10142a;
      border:1px solid #2a2f47;border-radius:10px;padding:8px 10px;margin-bottom:10px
    }
    .youbar .pill{
      background:#0f2b1e;border:1px solid #2a7a56;color:#baf8d2;
      border-radius:999px;padding:4px 8px;font-weight:700
    }
    .tr-hi{background:#0f2b1e !important}
    .tr-hi td{border-bottom-color:#1c4b3a}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Takip√ßi Sava≈üƒ±</h1>
      <span class="badge" id="dateBadge"></span>
      <span class="badge">Toplam <b id="total">0</b> ki≈üi</span>
      <span class="badge">√ñncelik: <b id="prioCount">0</b></span>
      <div class="spacer"></div>
      <a class="igbtn" href="https://www.instagram.com/takipcisavasi" target="_blank" rel="noreferrer">
        instagram.com/takipcisavasi
      </a>
    </header>

    <div class="row">
      <!-- SOL: Lƒ∞STE -->
      <section class="card">
        <div class="rowtop">
          <strong style="font-size:16px">Top 100</strong>
          <div class="spacer"></div>
          <div class="search">
            <input id="q" placeholder="@kullanƒ±cƒ± bul" />
            <button id="btnShow">Sƒ±rayƒ± G√∂ster</button>
            <label class="muted" style="margin-left:8px">Sayfa</label>
            <select id="page">
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option>
              <option>9</option><option>10</option>
            </select>
            <button id="btnPage">G√∂r√ºnt√ºle</button>
          </div>
        </div>

        <!-- Sorgu sonucu barƒ± -->
        <div id="youBar" class="youbar"></div>

        <table id="tbl">
          <thead>
            <tr><th>#</th><th>Kullanƒ±cƒ±</th><th class="muted">Not</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="footer">¬© 2025 ‚Ä¢ <a class="muted" href="./data/top1000.csv" target="_blank">top1000.csv</a></div>
      </section>

      <!-- SAƒû: TOP 5 -->
      <aside class="card">
        <div class="rowtop"><strong style="font-size:16px">ƒ∞lk 5</strong></div>
        <div id="top5"></div>
      </aside>
    </div>
  </div>

  <script>
    /* ---------- yardƒ±mcƒ±lar ---------- */
    const $ = (s, d=document)=> d.querySelector(s);
    const fmtDate = (d)=> d.toISOString().slice(0,10);

    // PRNG (deterministik karƒ±≈ütƒ±rma)
    function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^(h>>>16))>>>0}}
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    function shuffleSeed(arr, seedStr){
      const seed = xmur3(seedStr)();
      const rand = mulberry32(seed);
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(rand()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    const today = new Date();
    const todayStr = fmtDate(today);
    $("#dateBadge").textContent = todayStr;

    /* ---------- avatar kaynaklarƒ± + fallback ---------- */
    const avatarURL = (u) =>
      `https://unavatar.io/instagram/${encodeURIComponent(u)}`;
    const avatarFallback = (u) =>
      `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(u)}&backgroundType=gradientLinear`;

    /* ---------- veri y√ºkleme ---------- */
    async function loadData(){
      const v = todayStr; // cache-buster
      const [csvFollowers, csvTop, bansJson] = await Promise.all([
        fetch("./data/followers.csv?v="+v).then(r=>r.text()),
        fetch("./data/top1000.csv?v="+v).then(r=>r.text()),
        fetch("./data/bans.json?v="+v).then(r=>r.json()).catch(()=>[])
      ]);

      const all = csvFollowers.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const top1000Raw = csvTop.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const bans = new Set((bansJson||[]).map(x=>x.toLowerCase()));

      const base = all.filter(u => u && !bans.has(u.toLowerCase()));
      const baseLower = new Set(base.map(u=>u.toLowerCase()));

      // top1000 -> sadece base'de olanlar sabit sƒ±rada
      const topFixed = top1000Raw.filter(u => baseLower.has(u.toLowerCase()));

      // diƒüerleri
      const topLower = new Set(topFixed.map(u=>u.toLowerCase()));
      const others = base.filter(u => !topLower.has(u.toLowerCase()));

      $("#total").textContent = base.length;
      $("#prioCount").textContent = topFixed.length;

      return {base, topFixed, others};
    }

    /* ---------- sƒ±ralama √ºret ---------- */
    function buildLeaderboard(base, topFixed, others, dateStr){
      // diƒüerleri g√ºnl√ºk deterministik karƒ±≈ütƒ±rƒ±lƒ±r
      const shuffled = shuffleSeed(others, "DAY-"+dateStr);
      const list = topFixed.concat(shuffled);

      // index haritasƒ±
      const idx = new Map(); list.forEach((u,i)=> idx.set(u.toLowerCase(),i));
      return {list, idx, topFixedCount: topFixed.length};
    }

    /* ---------- renderlar ---------- */
    function renderTable(lb, page=1, pageSize=100, highlightUser=null){
      const start = (page-1)*pageSize;
      const items = lb.list.slice(start, start+pageSize);
      const tb = $("#tbl tbody");
      tb.innerHTML = "";

      let hiRow = null;

      for (let i=0;i<items.length;i++){
        const rank = start+i+1;
        const u = items[i];
        const tag = rank <= lb.topFixedCount ? '√ñncelik' : '';
        const userLink = `https://www.instagram.com/${u}`;

        const rowHTML =
          `<tr>
            <td>${rank}</td>
            <td>
              <a class="userLink" href="${userLink}" target="_blank" rel="noreferrer">
                <span class="userCell">
                  <img class="ava"
                       src="${avatarURL(u)}"
                       referrerpolicy="no-referrer"
                       onerror="this.onerror=null; this.src='${avatarFallback(u)}';"
                       alt="">
                  @${u}
                </span>
              </a>
            </td>
            <td>${tag?`<span class="chip">${tag}</span>`:''}</td>
          </tr>`;
        tb.insertAdjacentHTML("beforeend", rowHTML);

        if (highlightUser && u.toLowerCase() === highlightUser.toLowerCase()){
          hiRow = tb.lastElementChild;
          hiRow.classList.add("tr-hi");
        }
      }

      // se√ßilen satƒ±ra yumu≈üak scroll
      if(hiRow){
        setTimeout(()=> hiRow.scrollIntoView({behavior:"smooth", block:"center"}), 50);
      }
    }

    function renderTop5(lb){
      const box = $("#top5");
      box.innerHTML = "";
      const first5 = lb.list.slice(0,5);

      first5.forEach((u, i)=>{
        const rank = i+1;
        let icon='';
        if(rank===1) icon = '<span class="cup gold">üèÜ</span>';
        else if(rank===2) icon = '<span class="cup silver">üèÜ</span>';
        else if(rank===3) icon = '<span class="cup bronze">üèÜ</span>';

        box.insertAdjacentHTML("beforeend",
          `<div class="top5-row" style="margin-bottom:10px">
            <div class="rank">${rank}</div>
            <img class="ava"
                 src="${avatarURL(u)}"
                 referrerpolicy="no-referrer"
                 onerror="this.onerror=null; this.src='${avatarFallback(u)}';"
                 alt="">
            <a class="userLink" href="https://www.instagram.com/${u}" target="_blank" rel="noreferrer">@${u}</a>
            <div style="margin-left:auto">${icon}</div>
          </div>`);
      });
    }

    // √ºstte sonu√ß barƒ±nƒ± doldur
    function showBanner(u, rank){
      const el = $("#youBar");
      el.innerHTML =
        `<img class="ava"
              src="${avatarURL(u)}"
              referrerpolicy="no-referrer"
              onerror="this.onerror=null; this.src='${avatarFallback(u)}';"
              alt="">
         <a class="userLink" href="https://www.instagram.com/${u}" target="_blank" rel="noreferrer">@${u}</a>
         <span class="pill">#${rank}</span>`;
      el.style.display = "flex";
    }

    function showUser(username, lb){
      const u = (username||"").trim().replace(/^@/,"");
      if(!u) return;
      const i = lb.idx.get(u.toLowerCase());
      if(i==null){ 
        $("#youBar").style.display="none";
        alert("@"+u+" bug√ºn listede bulunamadƒ±."); 
        return; 
      }
      const rank = i+1;
      showBanner(u, rank);

      const page = Math.floor(i/100)+1;
      $("#page").value = String(page);
      renderTable(lb, page, 100, u);
    }

    /* ---------- init ---------- */
    let LB=null;
    (async function(){
      try{
        const data = await loadData();
        LB = buildLeaderboard(data.base, data.topFixed, data.others, todayStr);
        renderTable(LB, 1, 100);
        renderTop5(LB);
      }catch(err){
        console.error(err);
        alert("Veri y√ºklenemedi. L√ºtfen daha sonra tekrar deneyin.");
      }
    })();

    // olaylar
    $("#btnPage").onclick = ()=>{
      const p = parseInt($("#page").value,10)||1;
      renderTable(LB, p, 100);
      $("#youBar").style.display="none";
    };
    $("#btnShow").onclick = ()=>{
      showUser($("#q").value, LB);
    };
    $("#q").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("#btnShow").click(); });
  </script>
</body>
</html>
