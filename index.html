<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Takip√ßi Sava≈üƒ±</title>
<style>
  :root{
    --bg:#0b0b12; --card:#141422; --muted:#a9a9b5; --text:#eaeaf2; --line:#26263a;
    --accent:#7c83ff; --chip:#1f2030; --ok:#39d98a; --hl:#103d2c; --hlb:#20c384;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;max-width:1200px;margin:16px auto 8px;padding:0 16px}
  h1{margin:0;font-size:20px}
  .tag{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
  .grow{flex:1}
  main{max-width:1200px;margin:0 auto;padding:0 16px 24px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  input,select,button{background:#101021;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  .btn{background:var(--accent);color:#fff;border:none}
  .btn-ghost{background:var(--chip);border:1px solid var(--line);color:var(--text)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted)}
  tbody tr:hover{background:#0f0f18}
  .muted{color:var(--muted)}
  .hl{background:var(--hl)!important;border-left:3px solid var(--hlb)}
  .err{background:#2a1212;border:1px solid #5e2a2a;color:#ffbdbd;padding:10px;border-radius:10px;margin:10px 0;display:none}
</style>
</head>
<body>
  <header>
    <h1>Takip√ßi Sava≈üƒ±</h1>
    <span class="tag">Toplam <b id="total">0</b> ki≈üi</span>
    <div class="grow"></div>
    <a class="tag" href="https://instagram.com/takipcisavasi" target="_blank" rel="noopener">instagram.com/takipcisavasi</a>
  </header>

  <main>
    <div id="err" class="err"></div>

    <div class="row">
      <input id="q" placeholder="@kullanƒ±cƒ± bul" class="grow" />
      <button id="btnFind" class="btn">Sƒ±rayƒ± G√∂ster</button>
      <span id="found" class="tag" style="display:none"></span>
      <div class="row" style="margin-left:auto">
        <label class="muted">Sayfa</label>
        <select id="page"></select>
        <button id="btnPage" class="btn-ghost">G√∂r√ºnt√ºle</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h3>Top 100</h3>
        <table id="tbl">
          <thead><tr><th style="width:64px">#</th><th>Kullanƒ±cƒ±</th><th class="muted" style="width:120px">Not</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Y√ºkleniyor‚Ä¶</td></tr></tbody>
        </table>
      </section>

      <aside class="card">
        <h3>ƒ∞lk 5</h3>
        <ol id="top5" style="list-style:none;padding:0;margin:0"></ol>
      </aside>
    </div>
  </main>

<script>
(function(){
  // CSV i√ßin birden fazla olasƒ± yol: ilk √ßalƒ±≈üanƒ± kullan
  const VER = '2025-08-23-02'; // deploy edince artƒ±r
  const CANDIDATES = [
    ./data/ranking.csv?v=${VER},
    ./data/followers.csv?v=${VER},
    /data/ranking.csv?v=${VER},
    /data/followers.csv?v=${VER}
  ];
  const PAGE_SIZE = 100;

  const $ = s => document.querySelector(s);
  const TBL = $('#tbl tbody');
  const PAGE = $('#page');
  const TOTAL = $('#total');
  const TOP5 = $('#top5');
  const FOUND = $('#found');
  const ERR = $('#err');

  let LIST = [];
  let INDEX = new Map();
  let currentPage = 1;

  // CSV satƒ±rƒ±nƒ± sƒ±rayƒ± bozmadan kullanƒ±cƒ± adƒ±na indirger:
  function lineToUser(line){
    if(!line) return '';
    let s = String(line).replace(/^\uFEFF/,'').trim();
    if(!s) return '';
    // "1. " / "1)" / "1-" ba≈ülƒ±k numaralarƒ±nƒ± kaldƒ±r (varsa)
    s = s.replace(/^\s*\d+[\.)-]?\s*/, '');
    // CSV'de virg√ºl varsa sadece ilk s√ºtunu al
    if (s.includes(',')) s = s.split(',')[0].trim();
    // ƒ∞lk kullanƒ±cƒ± adƒ± pattern'i
    const m = s.match(/@?[A-Za-z0-9._]+/);
    return m ? m[0].replace(/^@/, '') : '';
  }

  async function fetchFirst(urls){
    let lastErr = null;
    for(const u of urls){
      try{
        const r = await fetch(u, { cache:'no-store' });
        if(!r.ok){ lastErr = new Error(${u} ‚Üí ${r.status} ${r.statusText}); continue; }
        const text = await r.text();
        if(text && text.trim()){
          return { url:u, text };
        }else{
          lastErr = new Error(${u} bo≈ü d√∂nd√º);
        }
      }catch(e){
        lastErr = new Error(${u} hata: ${e.message||e});
      }
    }
    throw lastErr || new Error('Hi√ßbir CSV bulunamadƒ±');
  }

  function renderTop5(){
    TOP5.innerHTML = LIST.slice(0,5).map((u,i)=>`
      <li style="display:flex;gap:10px;align-items:center;background:#101021;border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:8px">
        <div style="width:28px;height:28px;border-radius:8px;background:var(--chip);border:1px solid var(--line);display:grid;place-items:center;color:var(--muted);font-weight:700">${i+1}</div>
        <div>@${u}</div>
        <div style="margin-left:auto">${i===0?'üèÜ':i===1?'ü•à':i===2?'ü•â':'üèÖ'}</div>
      </li>
    `).join('');
  }

  function fillPages(total){
    const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
    PAGE.innerHTML = '';
    for(let i=1;i<=pages;i++){
      const o=document.createElement('option');
      o.value=o.textContent=i;
      PAGE.appendChild(o);
    }
  }

  function renderPage(p, highlightUser){
    const pages = Math.max(1, Math.ceil(LIST.length/PAGE_SIZE));
    currentPage = Math.max(1, Math.min(p, pages));
    PAGE.value = String(currentPage);

    const start=(currentPage-1)*PAGE_SIZE;
    const end=Math.min(start+PAGE_SIZE, LIST.length);

    let rows='';
    const hi = highlightUser ? highlightUser.toLowerCase() : null;

    for(let i=start;i<end;i++){
      const u = LIST[i];
      const rank = i+1;
      const highlight = hi && u.toLowerCase()===hi ? ' class="hl"' : '';
      rows += `
        <tr${highlight}>
          <td>${rank}</td>
          <td>@${u}</td>
          <td class="muted"></td>
        </tr>`;
    }
    TBL.innerHTML = rows || <tr><td colspan="3" class="muted">Bu sayfada i√ßerik yok.</td></tr>;
  }

  function findAndShow(q){
    const name = (q||'').trim().replace(/^@/,'').toLowerCase();
    if(!name){ FOUND.style.display='none'; return; }
    const pos = INDEX.get(name);
    if(pos==null){
      FOUND.textContent='@'+name+' bulunamadƒ±';
      FOUND.className='tag';
      FOUND.style.display='inline-block';
      return;
    }
    const rank = pos+1;
    FOUND.textContent='@'+name+' ‚Üí #'+rank;
    FOUND.className='tag';
    FOUND.style.display='inline-block';

    const page = Math.floor((rank-1)/PAGE_SIZE)+1;
    renderPage(page, name);

    const idxInPage=(rank-1)%PAGE_SIZE;
    const tr=document.querySelector('#tbl tbody').children[idxInPage];
    if(tr){ tr.scrollIntoView({behavior:'smooth',block:'center'}); }
  }

  async function init(){
    ERR.style.display='none';
    TBL.innerHTML = <tr><td colspan="3" class="muted">Y√ºkleniyor‚Ä¶</td></tr>;
    try{
      const {url, text} = await fetchFirst(CANDIDATES);
      console.log('CSV kaynaƒüƒ±:', url);

      const lines = text.split(/\r?\n/);
      const users = [];
      for(const line of lines){
        const u = lineToUser(line);
        if(u) users.push(u);       // SIRA AYNEN KORUNUR
      }
      if(!users.length) throw new Error(url+' bo≈ü g√∂r√ºnd√º');

      LIST = users;
      INDEX.clear();
      // Aramada ilk g√∂r√ºlen rank‚Äôa gitmek i√ßin sadece ilk kar≈üƒ±la≈üƒ±lanƒ± kaydediyoruz:
      for(let i=0;i<LIST.length;i++){
        const k = LIST[i].toLowerCase();
        if(!INDEX.has(k)) INDEX.set(k, i);
      }

      TOTAL.textContent = LIST.length.toLocaleString('tr-TR');
      fillPages(LIST.length);
      renderTop5();
      renderPage(1);
    }catch(e){
      console.error(e);
      ERR.textContent = 'Veri y√ºklenemedi: '+(e.message||e);
      ERR.style.display='block';
      TBL.innerHTML = <tr><td colspan="3" class="muted">Y√ºkleme hatasƒ±.</td></tr>;
    }
  }

  // Eventler
  $('#btnPage').onclick = ()=> renderPage(parseInt(PAGE.value,10)||1);
  $('#btnFind').onclick = ()=> findAndShow($('#q').value);
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnFind').click(); });

  init();
})();
</script>
</body>
</html>
