<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BugÃ¼nkÃ¼ SÄ±ran</title>
<style>
:root{
  --bg:#0b0b12;--p1:#12121c;--p2:#17172a;--bd:#26263a;
  --tx:#eaeaf2;--mut:#a6a8b3;--brand:#7c5cff;--chip:#1b1b2d;
  --ok:#36c690;--row:#0f0f19
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--tx);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(to bottom,rgba(11,11,18,.95),rgba(11,11,18,.8));backdrop-filter:blur(6px);border-bottom:1px solid var(--bd)}
.wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
.hrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{margin:0;font-size:20px;font-weight:700}
.badge{background:var(--chip);border:1px solid var(--bd);color:var(--mut);border-radius:999px;padding:6px 10px;font-size:12px}
.flex1{flex:1}
.input{background:var(--p1);border:1px solid var(--bd);color:var(--tx);padding:10px 12px;border-radius:10px;min-width:220px;outline:none}
.btn{background:var(--brand);border:1px solid #6e53ff;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--tx);border-color:var(--bd)}
.btn:disabled{opacity:.5;cursor:not-allowed}
main{max-width:1100px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:16px}
.card{background:var(--p2);border:1px solid var(--bd);border-radius:14px;overflow:hidden}
.chead{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--bd)}
.ctitle{font-weight:700} .mut{color:var(--mut)} .ctrls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select{background:var(--p1);border:1px solid var(--bd);color:var(--tx);padding:8px 10px;border-radius:10px}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{font-size:12px;color:var(--mut);text-align:left;padding:10px 14px;border-bottom:1px solid var(--bd)}
tbody td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.04)}
tbody tr:nth-child(2n){background:var(--row)} tbody tr:hover{background:#141428}
.rank{font-variant-numeric:tabular-nums;width:88px} .user{font-weight:600} .note{color:var(--mut)}
.pill{display:inline-flex;align-items:center;gap:6px;background:#13132b;border:1px solid #2a2a52;color:#c8c9ff;border-radius:999px;padding:4px 8px;font-size:12px}
.trophy{font-size:16px}.gold{color:#ffcc3e}.silver{color:#c0c7d1}.bronze{color:#d89b6f}
.me{box-shadow:inset 0 0 0 2px var(--ok)} .me .user{color:#baf7dc}
.foot{padding:14px 16px;text-align:center;color:var(--mut);font-size:12px;border-top:1px solid var(--bd)}
@media (max-width:640px){.rank{width:64px}.input{min-width:160px}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="hrow">
      <h1>BugÃ¼nkÃ¼ SÄ±ran</h1>
      <span class="badge" id="today">â€”</span>
      <span class="badge">Toplam <b id="total">0</b> kiÅŸi</span>
      <span class="badge">Ã–ncelikli: <b id="activeCount">0</b></span>
      <div class="flex1"></div>
      <input id="search" class="input" placeholder="@kullanÄ±cÄ± bul"/>
      <button id="btnFind" class="btn">SÄ±rayÄ± GÃ¶ster</button>
      <button id="btnShare" class="btn ghost">PaylaÅŸ</button>
      <button id="btnLast" class="btn ghost">Benim SÄ±ram</button>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="chead">
      <div>
        <div class="ctitle">Top 100</div>
        <div class="mut" style="font-size:12px">Ä°lk 1000 CSVâ€™den; kalanlar gÃ¼nÃ¼n seedâ€™iyle dÃ¼zenlenir.</div>
      </div>
      <div class="ctrls">
        <label class="mut" for="page">Sayfa</label>
        <select id="page"></select>
        <button id="btnPage" class="btn ghost">GÃ¶rÃ¼ntÃ¼le</button>
      </div>
    </div>
    <table>
      <thead><tr><th class="rank">#</th><th>KullanÄ±cÄ±</th><th class="note">Not</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="foot">Â© 2025 â€¢ <a class="mut" href="/data/top1000.csv">top1000.csv</a></div>
  </section>

  <section id="youBox" class="card" style="display:none">
    <div class="chead">
      <div class="ctitle" id="youTitle">â€”</div>
      <div class="mut" id="youMeta">â€”</div>
    </div>
    <div style="padding:14px 16px">
      <div class="mut" id="youNeighbors">â€”</div>
    </div>
  </section>
</main>

<script>
/* ---------- kÃ¼Ã§Ã¼k yardÄ±mcÄ±lar ---------- */
const today = new Date();
const dayStr = today.toISOString().slice(0,10);
document.getElementById('today').textContent = dayStr;
const q = (s)=>document.querySelector(s);

/* deterministik PRNG */
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}return ()=>{h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^(h>>>16))>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
function shuffleSeed(arr,seedStr){const seed=xmur3(seedStr)();const rand=mulberry32(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

/* ---------- veri yÃ¼kleme ---------- */
async function loadAll(){
  const v=dayStr;
  const [csvAll,csvTop,bans] = await Promise.all([
    fetch(`/data/followers.csv?v=${v}`).then(r=>r.ok?r.text():""),
    fetch(`/data/top1000.csv?v=${v}`).then(r=>r.ok?r.text():""),
    fetch(`/data/bans.json?v=${v}`).then(r=>r.ok?r.json():[])
  ]);
  const followers = csvAll.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const banSet = new Set((bans||[]).map(s=>s.toLowerCase()));
  const base = followers.filter(u=>u && !banSet.has(u.toLowerCase())); // herkes burada
  const rawTop = csvTop.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const topSet = new Set(rawTop.map(s=>s.toLowerCase()));
  q('#total').textContent = base.length;
  q('#activeCount').textContent = rawTop.length;
  return {base, rawTop, topSet};
}

/* ---------- sÄ±ralama oluÅŸtur ---------- */
function makeLeaderboard(base, rawTop, topSet){
  const baseL = new Set(base.map(u=>u.toLowerCase()));
  const top = rawTop.filter(u=>baseL.has(u.toLowerCase())); // csvâ€™de olup takipÃ§i havuzunda olanlar
  const topL = new Set(top.map(u=>u.toLowerCase()));
  const others = base.filter(u=>!topL.has(u.toLowerCase()));
  const arranged = top.concat(shuffleSeed(others, 'DAY-'+dayStr)); // deterministik
  const idx = new Map(); arranged.forEach((u,i)=>idx.set(u.toLowerCase(),i));
  return {list:arranged, idx, topCount:top.length};
}

/* ---------- render ---------- */
const PAGE=100;
function fillPages(total){
  const sel=q('#page'); sel.innerHTML="";
  const pages=Math.max(1,Math.ceil(total/PAGE));
  for(let i=1;i<=pages;i++){const o=document.createElement('option');o.value=i;o.textContent=i;sel.appendChild(o)}
}
function trophy(rank){
  if(rank===1) return '<span class="trophy gold">ðŸ¥‡</span>';
  if(rank===2) return '<span class="trophy silver">ðŸ¥ˆ</span>';
  if(rank===3) return '<span class="trophy bronze">ðŸ¥‰</span>';
  return '';
}
function render(list,page,highlightUser,topCount){
  const start=(page-1)*PAGE, end=Math.min(list.length,start+PAGE);
  const tb=q('#tbody'); tb.innerHTML="";
  for(let i=start;i<end;i++){
    const u=list[i]; const rank=i+1; const tr=document.createElement('tr');
    if(highlightUser && u.toLowerCase()===highlightUser.toLowerCase()) tr.classList.add('me');
    tr.innerHTML=`
      <td class="rank">${trophy(rank)} ${rank}</td>
      <td class="user">@${u}</td>
      <td class="note">${rank<=topCount?'<span class="pill">Ã–ncelikli</span>':''}</td>`;
    tb.appendChild(tr);
  }
}

/* ---------- arama ---------- */
function showUser(u,LB){
  const you=u.trim().replace(/^@/,'');
  if(!you){q('#youBox').style.display='none';return}
  const i=LB.idx.get(you.toLowerCase());
  if(i==null){ // (nadiren baseâ€™de olmayabilir)
    alert('@'+you+' bulunamadÄ±.');
    return;
  }
  const rank=i+1, total=LB.list.length;
  const pct=((rank/total)*100).toFixed(2);
  const from=Math.max(0,i-3), to=Math.min(total,i+4);
  const neigh=LB.list.slice(from,to).map((x,j)=>`${from+j+1}. @${x}`).join(' â€¢ ');
  q('#youBox').style.display='block';
  q('#youTitle').textContent='@'+you+'  â†’  #'+rank;
  q('#youMeta').textContent=`Toplam ${total} kiÅŸi â€¢ ilk %${pct}`;
  q('#youNeighbors').textContent=neigh;
  // sayfaya git & highlight
  const page=Math.floor(i/PAGE)+1;
  q('#page').value=String(page);
  render(LB.list,page,you,LB.topCount);
  // son aranan
  try{localStorage.setItem('last_user','@'+you)}catch{}
}

/* ---------- init ---------- */
let DATA=null, LB=null;
(async function(){
  try{
    DATA=await loadAll();
    LB=makeLeaderboard(DATA.base,DATA.rawTop,DATA.topSet);
    fillPages(LB.list.length);
    render(LB.list,1,null,LB.topCount);

    // URLâ€™den @u oku
    const params=new URLSearchParams(location.search);
    const u=params.get('u');
    if(u){ q('#search').value=u; showUser(u,LB); }

  }catch(e){
    console.error(e);
    alert('Veri yÃ¼klenemedi.');
  }
})();

/* ---------- UI baÄŸlama ---------- */
q('#btnPage').onclick=()=>{const p=parseInt(q('#page').value||'1',10); render(LB.list,p,q('#search').value.trim().replace(/^@/,''),LB.topCount)};
q('#btnFind').onclick=()=>{const v=q('#search').value; if(v){ showUser(v,LB); }};
q('#btnShare').onclick=async()=>{
  const u=q('#search').value.trim(); if(!u) return;
  const url=new URL(location.href); url.searchParams.set('u',u.startsWith('@')?u:'@'+u);
  try{await navigator.clipboard.writeText(url.toString()); alert('BaÄŸlantÄ± kopyalandÄ±.');}catch{prompt('BaÄŸlantÄ±yÄ± kopyala:',url.toString())}
};
q('#btnLast').onclick=()=>{try{const u=localStorage.getItem('last_user'); if(u){q('#search').value=u; showUser(u,LB);} }catch{}};
</script>
</body>
</html>
