<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Takipçi Savaşı</title>
<style>
  :root{
    --bg:#0b0b12; --card:#141422; --muted:#a9a9b5; --text:#eaeaf2;
    --line:#26263a; --accent:#7c83ff; --chip:#1f2030; --ok:#39d98a;
    --row:#101021; --row2:#0f0f19;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    max-width:1200px;margin:16px auto 8px;padding:0 16px}
  h1{margin:0;font-size:20px}
  .tag{background:var(--chip);border:1px solid var(--line);color:var(--muted);
    padding:6px 10px;border-radius:999px;font-size:12px}
  .grow{flex:1}
  main{max-width:1200px;margin:0 auto;padding:0 16px 24px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  input,select,button{background:var(--row);border:1px solid var(--line);color:var(--text);
    border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  .btn{background:var(--accent);color:#fff;border:none}
  .btn-ghost{background:var(--chip);border:1px solid var(--line);color:var(--text)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted)}
  tbody tr:hover{background:var(--row2)}
  .muted{color:var(--muted)}
  .hl{background:rgba(57,217,138,.14)!important}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
  .chip.ok{color:#bfffe2;border-color:#2f7b5d;background:#0d1b12}
  .usercell{display:flex;align-items:center;gap:10px}
  .ava{width:28px;height:28px;border-radius:50%;border:1px solid var(--line);background:#0e0e18;flex:0 0 28px;object-fit:cover}
  .top5{list-style:none;margin:0;padding:0}
  .top5 li{display:flex;align-items:center;gap:10px;background:var(--row);border:1px solid var(--line);
    border-radius:10px;padding:10px;margin-bottom:8px}
  .badge{display:grid;place-items:center;width:28px;height:28px;border-radius:8px;background:var(--chip);color:var(--muted);font-weight:700}
</style>
</head>
<body>
  <header>
    <h1>Takipçi Savaşı</h1>
    <span class="tag">Toplam <b id="total">0</b> kişi</span>
    <div class="grow"></div>
    <a class="tag" href="https://www.instagram.com/takipcisavasi" target="_blank" rel="noopener">instagram.com/takipcisavasi</a>
  </header>

  <main>
    <div class="row">
      <input id="q" placeholder="@kullanıcı bul" class="grow" />
      <button id="btnFind" class="btn">Sırayı Göster</button>
      <span id="found" class="chip" style="display:none"></span>
      <div class="row" style="margin-left:auto">
        <label class="muted">Sayfa</label>
        <select id="page"></select>
        <button id="btnPage" class="btn-ghost">Görüntüle</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h3>Top 100</h3>
        <table id="tbl">
          <thead><tr><th style="width:64px">#</th><th>Kullanıcı</th><th class="muted" style="width:120px">Not</th></tr></thead>
          <tbody><tr><td colspan="3" class="muted">Yükleniyor…</td></tr></tbody>
        </table>
      </section>

      <aside class="card">
        <h3>İlk 5</h3>
        <ol id="top5" class="top5"></ol>
      </aside>
    </div>
  </main>

<script>
(function(){
  const CSV_URL = '/data/ranking.csv';   // tek veri kaynağı
  const PAGE_SIZE = 100;

  const $ = s => document.querySelector(s);
  const TBL = $('#tbl tbody');
  const PAGE = $('#page');
  const TOTAL = $('#total');
  const TOP5 = $('#top5');
  const FOUND = $('#found');

  let LIST = [];
  let INDEX = new Map();
  let currentPage = 1;

  const norm = s => (s||'').trim().replace(/^@/,'').toLowerCase();

  function uniquePreserve(arr){
    const seen=new Set(), out=[];
    for(const raw of arr){
      const u=norm(raw);
      if(!u) continue;
      if(seen.has(u)) continue;
      seen.add(u);
      out.push(u);
    }
    return out;
  }

  async function load(){
    try{
      const r = await fetch(CSV_URL, {cache:'no-store'});
      if(!r.ok) throw new Error('ranking.csv '+r.status);
      const text = await r.text();
      LIST = uniquePreserve(text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean));
      INDEX.clear(); LIST.forEach((u,i)=>INDEX.set(u,i));
      TOTAL.textContent = LIST.length.toLocaleString('tr-TR');
      fillPages(LIST.length);
      renderTop5();
      renderPage(1);
    }catch(e){
      console.error(e);
      TBL.innerHTML = <tr><td colspan="3" class="muted">Veri yüklenemedi.</td></tr>;
    }
  }

  function avatarUrl(u){
    // unavatar: instagram kullanıcı avatarı (3rd-party). Hata olursa img gizleniyor.
    return https://unavatar.io/instagram/${encodeURIComponent(u)};
  }

  function renderTop5(){
    const cups = ['🥇','🥈','🥉','🏅','🏅'];
    TOP5.innerHTML = LIST.slice(0,5).map((u,i)=>`
      <li>
        <div class="badge">${i+1}</div>
        <img class="ava" loading="lazy" referrerpolicy="no-referrer"
             src="${avatarUrl(u)}"
             alt="@${u}"
             onerror="this.style.display='none'">
        <div>@${u}</div>
        <div style="margin-left:auto">${cups[i]||''}</div>
      </li>
    `).join('');
  }

  function renderPage(p, highlightUser){
    currentPage = Math.max(1, Math.min(p, Math.ceil(LIST.length/PAGE_SIZE)));
    PAGE.value = String(currentPage);
    const start=(currentPage-1)*PAGE_SIZE, end=Math.min(start+PAGE_SIZE, LIST.length);
    let rows='';
    for(let i=start;i<end;i++){
      const u=LIST[i], rank=i+1;
      const isMe = highlightUser && norm(highlightUser)===u;
      rows += `
        <tr class="${isMe?'hl':''}">
          <td>${rank}</td>
          <td>
            <div class="usercell">
              <img class="ava" loading="lazy" referrerpolicy="no-referrer"
                   src="${avatarUrl(u)}"
                   alt="@${u}"
                   onerror="this.style.display='none'">
              <span>@${u}</span>
            </div>
          </td>
          <td class="muted">${rank<=5?'Öncelik':''}</td>
        </tr>`;
    }
    TBL.innerHTML = rows || <tr><td colspan="3" class="muted">Bu sayfada içerik yok.</td></tr>;
  }

  function fillPages(total){
    const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
    PAGE.innerHTML = Array.from({length:pages}, (_,i)=><option value="${i+1}">${i+1}</option>).join('');
  }

  function findUser(q){
    const u = norm(q);
    if(!u) return null;
    const i = INDEX.get(u);
    return i==null ? null : {index:i, rank:i+1, user:u};
  }

  $('#btnFind').onclick = ()=>{
    const q = $('#q').value;
    const res = findUser(q);
    if(!res){
      FOUND.textContent = '@'+q+' bulunamadı';
      FOUND.className = 'chip';
      FOUND.style.display='inline-block';
      return;
    }
    const page = Math.floor((res.rank-1)/PAGE_SIZE)+1;
    renderPage(page, res.user);
    FOUND.textContent = '@'+res.user+' → #'+res.rank;
    FOUND.className = 'chip ok';
    FOUND.style.display='inline-block';
    // tabloya odakla
    const top = document.querySelector('main').offsetTop;
    window.scrollTo({top: top-8, behavior:'smooth'});
  };

  $('#btnPage').onclick = ()=>{
    const p = parseInt(PAGE.value,10)||1;
    renderPage(p);
  };

  $('#q').addEventListener('keydown', e=>{
    if(e.key==='Enter') $('#btnFind').click();
  });

  load();
})();
</script>
</body>
</html>
