<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TakipÃ§i SavaÅŸÄ±</title>
  <style>
    :root{
      --bg:#0b0b12; --card:#141422; --muted:#aaa; --text:#eee; --border:#26263a;
      --accent:#7e86ff; --accent-2:#5a64ff; --ok:#15c27a;
      --chip:#1d1d2b; --chip-b:#32324a;
      --highlight:#103d2c; --highlight-border:#20c384;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1150px;margin:0 auto;padding:16px}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .badge{background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px;color:#d0d0ff;font-size:12px}
    .btn{background:var(--accent);border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .ghost{background:#1c1c2a;color:#cfd0ff}
    .btn:active{transform:translateY(1px)}
    .grow{flex:1}
    input,select{background:#10101a;color:var(--text);border:1px solid #2b2b3c;border-radius:10px;padding:10px 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1c1c2b}
    th{color:var(--muted);font-weight:600;text-align:left}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .top5-item{display:flex;align-items:center;gap:10px;background:#11111b;border:1px solid var(--border);padding:10px;border-radius:12px}
    .rankDot{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#1a1a27;border:1px solid #2b2b3c;color:#cfd0ff;font-weight:700}
    .cup{font-size:14px}
    .success{background:#11251d;border:1px solid #1e6346;color:#73f0b9}
    .hl{background:var(--highlight)!important;border-left:3px solid var(--highlight-border)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px;font-size:12px}
    .footer{opacity:.6;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TakipÃ§i SavaÅŸÄ±</h1>
      <span class="chip" id="today"></span>
      <span class="badge">Toplam <b id="total">0</b> kiÅŸi</span>
      <span class="badge">Ã–ncelik: <b id="activeCount">0</b></span>
      <div class="grow"></div>
      <a class="badge" href="https://instagram.com/takipcisavasi" target="_blank" rel="noopener">instagram.com/takipcisavasi</a>
    </header>

    <div class="row" style="margin-bottom:12px">
      <input id="q" placeholder="@kullanÄ±cÄ± bul" class="grow" />
      <button id="btnFind" class="btn">SÄ±rayÄ± GÃ¶ster</button>
      <span class="chip" id="foundInfo" style="display:none"></span>
      <div class="right row">
        <label class="muted">Sayfa:</label>
        <select id="page"></select>
        <button id="btnPage" class="btn ghost">GÃ¶rÃ¼ntÃ¼le</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="row" style="margin-bottom:8px">
          <strong>Top 100</strong>
          <div class="right chips">
            <span class="chip">Ä°lk 1000 sabit, diÄŸerleri sabit karÄ±ÅŸÄ±k</span>
          </div>
        </div>
        <table id="tbl">
          <thead><tr><th style="width:56px">#</th><th>KullanÄ±cÄ±</th><th class="muted" style="width:130px">Not</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="footer muted">Â© 2025</div>
      </section>

      <aside class="card">
        <div class="row" style="margin-bottom:8px">
          <strong>Ä°lk 5</strong>
        </div>
        <div id="top5" class="row" style="flex-direction:column;gap:8px"></div>
      </aside>
    </div>
  </div>

<script>
/* ========== YardÄ±mcÄ±lar ========== */
function parseCSV(raw){
  return raw.split(/\r?\n/)
    .map(s=>s.trim())
    .filter(Boolean)
    .map(line=>{
      // "1. kullanici_adi" veya "1) @kullanici" gibi satÄ±rlardan SADECE kullanÄ±cÄ±yÄ± al
      // son kelimeyi al, baÅŸtaki @ iÅŸaretini temizle
      const parts=line.split(/\s+/);
      const last=parts[parts.length-1];
      return last.replace(/^@/,'');
    });
}

// tek seferlik deterministik karÄ±ÅŸtÄ±rma
function makeSeed(){
  const k='takipci_savasi_static_seed';
  let s=localStorage.getItem(k);
  if(!s){ s=String(Math.floor(Math.random()*1e9)); localStorage.setItem(k,s); }
  return Number(s)>>>0;
}
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return(h^(h>>>16))>>>0;};}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}
function shuffleDeterministic(arr,seedNumber){
  const rand=mulberry32(seedNumber);
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(rand()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ========== Tarih / BaÅŸlÄ±k ========== */
const todayStr=new Date().toISOString().slice(0,10);
document.getElementById("today").textContent=todayStr;

/* ========== Veri ========== */
async function loadData(){
  const [csvAll,csvTop,bans]=await Promise.all([
    fetch("./data/followers.csv").then(r=>r.text()),
    fetch("./data/top1000.csv").then(r=>r.text()),
    fetch("./data/bans.json").then(r=>r.json()).catch(()=>[])
  ]);

  const followers=parseCSV(csvAll);
  const topCSV=parseCSV(csvTop);

  const banSet=new Set((bans||[]).map(s=>s.toLowerCase()));
  const base=followers.filter(u=>u && !banSet.has(u.toLowerCase()));

  // ilk1000 (top1k) CSV sÄ±rasÄ± korunacak; base iÃ§inde olanlar
  const baseLower=new Set(base.map(u=>u.toLowerCase()));
  const top = topCSV.filter(u=>baseLower.has(u.toLowerCase()));

  // diÄŸerleri
  const topLower=new Set(top.map(u=>u.toLowerCase()));
  const others=base.filter(u=>!topLower.has(u.toLowerCase()));

  document.getElementById("total").textContent=base.length;
  document.getElementById("activeCount").textContent=topCSV.length;

  return {base, top};
}

/* ========== SÄ±ralama / Render ========== */
const PAGE_SIZE=100;
let LB=null;

function buildLeaderboard(base, top){
  // diÄŸerleri deterministik shuffle (refresh ile deÄŸiÅŸmesin)
  const seed=makeSeed(); // sabit
  const othersSet=new Set(top.map(x=>x.toLowerCase()));
  const others=base.filter(u=>!othersSet.has(u.toLowerCase()));
  const shuffled=shuffleDeterministic(others, seed);

  const list=top.concat(shuffled);
  const idx=new Map();
  list.forEach((u,i)=>idx.set(u.toLowerCase(),i));
  return {list, idx, top};
}

function fillPageSelect(total){
  const pages=Math.max(1,Math.ceil(total/PAGE_SIZE));
  const sel=document.getElementById("page");
  sel.innerHTML='';
  for(let i=1;i<=pages;i++){
    const opt=document.createElement('option');
    opt.value=String(i);
    opt.textContent=String(i);
    sel.appendChild(opt);
  }
}

function renderTable(list,page=1,highlightUser){
  const start=(page-1)*PAGE_SIZE;
  const items=list.slice(start,start+PAGE_SIZE);
  const tb=document.querySelector("#tbl tbody");
  tb.innerHTML='';

  const endHighlight = highlightUser ? highlightUser.toLowerCase() : null;

  for(let i=0;i<items.length;i++){
    const tr=document.createElement('tr');
    const rank=start+i+1;

    const td1=document.createElement('td'); td1.textContent=rank;
    const td2=document.createElement('td'); td2.textContent='@'+items[i];
    const td3=document.createElement('td'); td3.className='muted';
    if(rank<=1000) td3.textContent='Ã–ncelik';

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);

    if(endHighlight && items[i].toLowerCase()===endHighlight){
      tr.classList.add('hl');
    }
    tb.appendChild(tr);
  }
}

function renderTop5(top){
  const c=document.getElementById('top5');
  c.innerHTML='';
  const first5=top.slice(0,5);
  first5.forEach((u,i)=>{
    const row=document.createElement('div');
    row.className='top5-item';
    const dot=document.createElement('div');
    dot.className='rankDot';
    dot.textContent=String(i+1);
    const name=document.createElement('div');
    name.textContent='@'+u;
    const cup=document.createElement('div');
    cup.className='cup';
    if(i===0) cup.textContent='ðŸ†';
    else if(i===1) cup.textContent='ðŸ¥ˆ';
    else if(i===2) cup.textContent='ðŸ¥‰';
    row.appendChild(dot); row.appendChild(name); row.appendChild(cup);
    c.appendChild(row);
  });
}

/* ========== Arama / YardÄ±mcÄ± ========== */
function scrollToRank(rank){
  const page=Math.max(1,Math.ceil(rank/PAGE_SIZE));
  document.getElementById('page').value=String(page);
  renderTable(LB.list, page);
  // tablo renderlandÄ±ktan sonra rowâ€™u highlight edelim
  const tb=document.querySelector("#tbl tbody");
  const idxInPage=(rank-1)%PAGE_SIZE;
  const tr=tb.children[idxInPage];
  if(tr){ tr.classList.add('hl'); tr.scrollIntoView({behavior:'smooth',block:'center'}); }
}

function findAndShow(username){
  if(!username) return;
  const u=username.replace(/^@/,'').trim().toLowerCase();
  const pos = LB.idx.get(u);
  const info=document.getElementById('foundInfo');
  if(pos==null){
    info.textContent='@'+username+' bulunamadÄ±';
    info.className='chip';
    info.style.display='inline-block';
    return;
  }
  const rank=pos+1;
  info.textContent='@'+username+' â†’ #'+rank;
  info.className='chip success';
  info.style.display='inline-block';
  scrollToRank(rank);
}

/* ========== BaÅŸlat ========== */
(async function(){
  const data = await loadData();
  LB = buildLeaderboard(data.base, data.top);

  fillPageSelect(LB.list.length);
  renderTable(LB.list,1);
  renderTop5(LB.top);
})();

/* ========== UI ========== */
document.getElementById('btnPage').onclick=()=>{
  const p=parseInt(document.getElementById('page').value,10)||1;
  renderTable(LB.list,p);
};
document.getElementById('btnFind').onclick=()=>{
  const q=document.getElementById('q').value.trim();
  findAndShow(q);
};
document.getElementById('q').addEventListener('keydown',e=>{
  if(e.key==='Enter'){ document.getElementById('btnFind').click(); }
});
</script>
</body>
</html>
