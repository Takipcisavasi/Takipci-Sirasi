<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TakipÃ§i SavaÅŸÄ±</title>
  <style>
    :root{
      --bg:#0b0b12; --card:#141422; --card2:#10101a;
      --border:#26263a; --muted:#a9a9b5; --text:#eaeaf2;
      --accent:#7c83ff; --accent-2:#5b61e8; --good:#39d98a; --chip:#1f2030;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .tag{background:var(--chip);border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
    .grow{flex:1}
    .btn{background:var(--accent);border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:var(--chip);color:var(--text);border:1px solid var(--border)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
    main{margin-top:14px;display:grid;grid-template-columns: 1fr 320px;gap:14px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .card h3{margin:0 0 10px 0;font-size:14px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:9px 8px;border-bottom:1px solid var(--border)}
    th{font-weight:600;color:var(--muted);text-align:left}
    tbody tr:hover{background:#0f0f18}
    .muted{color:var(--muted)}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .me{background:#0d1b12 !important}
    .me td{color:#a3ffca}
    .right{margin-left:auto}
    .top5 li{display:flex;align-items:center;gap:10px;background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px}
    .idx{width:28px;height:28px;border-radius:8px;background:var(--chip);display:grid;place-items:center;color:var(--muted);font-weight:600}
    .trophy{font-size:16px}
    .top1 .idx{background:linear-gradient(90deg,#ffd54f,#ffea00);color:#4a3f00}
    .top2 .idx{background:linear-gradient(90deg,#d7d7d7,#f3f3f3);color:#2f2f2f}
    .top3 .idx{background:linear-gradient(90deg,#f4a261,#ffcc80);color:#4a2500}
    .you{background:#0d1b12;border:1px dashed #295c44}
    .you strong{color:#71ffb2}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TakipÃ§i SavaÅŸÄ±</h1>
      <span class="tag" id="metaTotal">Toplam 0 kiÅŸi</span>
      <span class="tag" id="metaTop">Ã–ncelik: 1000</span>
      <div class="grow"></div>
      <a class="tag" href="https://www.instagram.com/takipcisavasi" target="_blank" rel="noopener">instagram.com/takipcisavasi</a>
    </header>

    <div class="row" style="margin-top:10px">
      <input id="q" placeholder="@kullanÄ±cÄ± bul" class="grow">
      <button class="btn" id="btnFind">SÄ±rayÄ± GÃ¶ster</button>
      <label class="muted">Sayfa</label>
      <select id="pageSel"></select>
      <button class="btn-ghost" id="btnPage">GÃ¶rÃ¼ntÃ¼le</button>
    </div>

    <main>
      <section class="card">
        <div class="row">
          <h3>Top 100</h3>
          <div class="right muted" id="today"></div>
        </div>
        <table>
          <thead><tr><th>#</th><th>KullanÄ±cÄ±</th><th class="muted">Not</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>

      <aside class="card">
        <h3>Ä°lk 5</h3>
        <ol id="top5" class="top5" style="list-style:none;padding:0;margin:0"></ol>

        <div id="youCard" class="card you hidden" style="margin-top:12px">
          <strong id="youTitle">@kullanÄ±cÄ±</strong>
          <div id="youInfo" class="muted" style="margin-top:6px"></div>
        </div>
      </aside>
    </main>
  </div>

<script>
/* ---------- PRNG ---------- */
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^(h>>>16))>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function shuffleDeterministic(arr, seedNum){
  const r = mulberry32(seedNum); const a = arr.slice();
  for(let i=a.length-1;i>0;i--){const j=(r()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]}
  return a;
}

/* ---- Sabit seed (tÃ¼m cihazlarda aynÄ± sÄ±ra) ---- */
const GLOBAL_SEED_TEXT = "takipcisavasi-v1";
const GLOBAL_SEED_NUM  = xmur3(GLOBAL_SEED_TEXT)();

/* ---------- Helpers ---------- */
const fmtDate = d => d.toISOString().slice(0,10);
document.getElementById('today').textContent = fmtDate(new Date());

/* ---------- Data load ---------- */
async function loadData(){
  const v=fmtDate(new Date()); // basit cache-buster
  const [csvAll,csvTop,bans] = await Promise.all([
    fetch('./data/followers.csv?v='+v).then(r=>r.text()),
    fetch('./data/top1000.csv?v='+v).then(r=>r.text()).catch(()=>''), // top1000 zorunlu
    fetch('./data/bans.json?v='+v).then(r=>r.json()).catch(()=>[])
  ]);
  const followers = csvAll.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const top1000  = csvTop.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const banSet = new Set((bans||[]).map(x=>x.toLowerCase()));

  // banlarÄ± temizle
  const base = followers.filter(u=>!banSet.has(u.toLowerCase()));
  document.getElementById('metaTotal').textContent = "Toplam " + base.length + " kiÅŸi";
  document.getElementById('metaTop').textContent   = "Ã–ncelik: 1000";
  return {base, top1000};
}

/* ---------- Build leaderboard ---------- */
function buildLeaderboard(base, top1000){
  // Top 1000: orijinal listedeki sÄ±rayla (banlanmÄ±ÅŸlar zaten baseâ€™den Ã§Ä±karÄ±ldÄ±)
  const baseLower = new Set(base.map(u=>u.toLowerCase()));
  const fixedTop  = top1000.filter(u=>baseLower.has(u.toLowerCase()));

  // Others: deterministik karÄ±ÅŸtÄ±r
  const topSet = new Set(fixedTop.map(u=>u.toLowerCase()));
  const others = base.filter(u=>!topSet.has(u.toLowerCase()));
  const shuffled = shuffleDeterministic(others, GLOBAL_SEED_NUM);

  const list = fixedTop.concat(shuffled);
  const idx  = new Map(); list.forEach((u,i)=>idx.set(u.toLowerCase(), i));
  return { list, idx, fixedTop };
}

/* ---------- UI ---------- */
function renderTop5(list){
  const ul = document.getElementById('top5'); ul.innerHTML='';
  const labels=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','',''];
  for(let i=0;i<5 && i<list.length;i++){
    const li=document.createElement('li');
    if(i===0) li.classList.add('top1'); if(i===1) li.classList.add('top2'); if(i===2) li.classList.add('top3');
    li.innerHTML = `<div class="idx">${i+1}</div><div>@${escapeHtml(list[i])}</div>
                    <div class="right trophy">${labels[i]||''}</div>`;
    ul.appendChild(li);
  }
}

function renderTable(list, page=1, pageSize=100, highlightUser=''){
  const start=(page-1)*pageSize, end=Math.min(start+pageSize, list.length);
  const tb = document.getElementById('tbody'); tb.innerHTML='';
  for(let i=start;i<end;i++){
    const u=list[i]; const tr=document.createElement('tr');
    const isTop=i<1000 ? "Ã–ncelik" : "";
    tr.innerHTML=<td>${i+1}</td><td>@${escapeHtml(u)}</td><td class="muted">${isTop}</td>;
    if(highlightUser && u.toLowerCase()===highlightUser.toLowerCase()) tr.classList.add('me');
    tb.appendChild(tr);
  }
}
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]))}

function fillPages(total, pageSize=100){
  const sel=document.getElementById('pageSel'); sel.innerHTML='';
  const pages=Math.max(1, Math.ceil(total/pageSize));
  for(let i=1;i<=pages;i++){ const o=document.createElement('option'); o.value=o.textContent=i; sel.appendChild(o); }
}

/* ---------- Search & "Benim sÄ±ram" ---------- */
function showYouCard(username, lb){
  const c=document.getElementById('youCard');
  if(!username){ c.classList.add('hidden'); return; }
  const i = lb.idx.get(username.toLowerCase());
  if(i==null){ c.classList.remove('hidden'); c.classList.add('you'); 
    document.getElementById('youTitle').textContent = '@'+username;
    document.getElementById('youInfo').textContent  = 'BugÃ¼n listede bulunamadÄ±.';
    return;
  }
  const rank=i+1, total=lb.list.length;
  const from=Math.max(0,i-3), to=Math.min(total,i+4);
  const neighbors = lb.list.slice(from,to).map((x,j)=>${from+j+1}. @${x}).join('  â€¢  ');
  c.classList.remove('hidden');
  document.getElementById('youTitle').textContent = @${lb.list[i]} â†’ #${rank};
  document.getElementById('youInfo').textContent  = neighbors;
}

/* ---------- App ---------- */
let LB=null; // {list, idx, fixedTop}
let CURRENT_PAGE=1;

(async function init(){
  try{
    const data = await loadData();
    LB = buildLeaderboard(data.base, data.top1000);

    // ilk tablo + top5
    renderTop5(LB.list);
    fillPages(LB.list.length, 100);
    renderTable(LB.list, 1);

    // Arama/gÃ¶ster butonlarÄ±
    document.getElementById('btnFind').onclick = ()=>{
      const q = document.getElementById('q').value.trim().replace(/^@/,'');
      if(!q){ showYouCard('', LB); return; }
      const i = LB.idx.get(q.toLowerCase());
      if(i!=null){
        CURRENT_PAGE = Math.floor(i/100)+1;
        document.getElementById('pageSel').value = CURRENT_PAGE;
        renderTable(LB.list, CURRENT_PAGE, 100, q);
      }else{
        // listede yoksa mevcut sayfayÄ± koru, highlight yok
        renderTable(LB.list, CURRENT_PAGE, 100);
      }
      showYouCard(q, LB);
    };
    document.getElementById('btnPage').onclick = ()=>{
      const p = parseInt(document.getElementById('pageSel').value,10)||1;
      CURRENT_PAGE=p; renderTable(LB.list, p, 100);
      showYouCard('', LB);
    };
  }catch(e){
    console.error(e);
    alert('Veriler yÃ¼klenemedi.'); 
  }
})();
</script>
</body>
</html>
