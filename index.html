<script>
function xmur3(s){let h=1779033703^s.length;for(let i=0;i<s.length;i++){h=Math.imul(h^s.charCodeAt(i),3432918353);h=h<<13|h>>>19}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^(h>>>16))>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function shuffleSeed(arr,seedStr){const seed=xmur3(seedStr)();const rand=mulberry32(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

const todayStr=new Date().toISOString().slice(0,10);
document.getElementById("today").textContent=todayStr;
const v=todayStr; // cache-buster

async function loadData(){
  try{
    const [csvAll,csvTop,bans] = await Promise.all([
      fetch(`/data/followers.csv?v=${v}`).then(r=>{if(!r.ok)throw new Error('followers.csv '+r.status);return r.text()}),
      fetch(`/data/top1000.csv?v=${v}`).then(r=>r.ok?r.text():""),
      fetch(`/data/bans.json?v=${v}`).then(r=>r.ok?r.json():[])
    ]);
    const followers = (csvAll||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const banSet = new Set((bans||[]).map(s=>s.toLowerCase()));
    const base = followers.filter(u=>u && !banSet.has(u.toLowerCase()));

    const rawTop = (csvTop||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const topSet = new Set(rawTop.map(s=>s.toLowerCase()));

    console.log("Loaded:", {followers:followers.length, base:base.length, top1000:rawTop.length, bans:(bans||[]).length});
    document.getElementById("total").textContent = base.length;
    document.getElementById("activeCount").textContent = rawTop.length;

    return { base, rawTop, topSet };
  }catch(err){
    console.error("DATA LOAD ERROR:", err);
    alert("Veri yüklenemedi: "+err.message);
    return { base:[], rawTop:[], topSet:new Set() };
  }
}

function buildDailyLeaderboard(base, rawTop, topSet, dateStr){
  // top1000'de olup base'de de olanlar, verilen sırayı KORU
  const baseLower = new Set(base.map(u=>u.toLowerCase()));
  const top = rawTop.filter(u=>baseLower.has(u.toLowerCase()));
  // Diğerleri
  const topLower = new Set(top.map(u=>u.toLowerCase()));
  const others = base.filter(u=>!topLower.has(u.toLowerCase()));
  // Günlük karıştır
  const shuffledOthers = shuffleSeed(others, "DAY-"+dateStr);
  const list = top.concat(shuffledOthers);
  const idx = new Map(); list.forEach((u,i)=>idx.set(u.toLowerCase(), i));
  console.log("LB:", {total:list.length, top:top.length, others:shuffledOthers.length, sample:list.slice(0,5)});
  return {
