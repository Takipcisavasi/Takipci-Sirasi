<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Takip√ßi Sava≈üƒ±</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b0b12;--card:#141422;--muted:#a9adbb;--text:#e8eaf2;
      --border:#222432;--accent:#7c7cff;--pill:#1e1e2e;
      --success:#10b981;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;flex-wrap:wrap;gap:12px;border-bottom:1px solid var(--border);padding-bottom:8px}
    .title{font-weight:700;font-size:20px}
    .badge{background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .ig-btn{padding:8px 12px;border:1px solid var(--border);background:#15162a;border-radius:999px;color:#c8cbff;text-decoration:none}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    input,select,button{background:#10121c;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px;font-size:14px}
    button{cursor:pointer;background:var(--accent);border:none}
    .grid{display:grid;grid-template-columns:1fr 300px;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;font-size:14px}
    th{color:var(--muted);text-align:left}
    tr:hover{background:#10121c}
    .rank{width:36px;text-align:right;color:#9aa0b4}
    .note-chip{background:#152226;color:#93e5c7;border:1px solid #1d3b37;font-size:12px;border-radius:999px;padding:3px 6px}
    .handle{color:#eaf0ff}
    .you-card{display:none;margin-top:10px}
    .you-card.show{display:block}
    .green{background:#052;border:1px solid #094;color:#aef1cd;padding:3px 8px;border-radius:999px;font-size:12px}
    .top5 .item{display:flex;justify-content:space-between;padding:8px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Takip√ßi Sava≈üƒ±</div>
    <span class="badge" id="today"></span>
    <span class="badge">Toplam <span id="total">0</span> ki≈üi</span>
    <span class="badge">√ñncelik: <span id="activeCount">1000</span></span>
    <div class="spacer"></div>
    <a class="ig-btn" href="https://www.instagram.com/takipcisavasi" target="_blank">instagram.com/takipcisavasi</a>
  </header>

  <div class="controls">
    <input id="search" placeholder="@kullanƒ±cƒ± bul"/>
    <button id="btnFind">Sƒ±rayƒ± G√∂ster</button>
    <span class="spacer"></span>
    <label>Sayfa</label>
    <select id="page"></select>
    <button id="btnPage">G√∂r√ºnt√ºle</button>
  </div>

  <div class="card you-card" id="youCard">
    <div id="youTitle"></div>
    <div id="youNeighbors" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="grid">
    <div class="card">
      <table id="tbl">
        <thead><tr><th class="rank">#</th><th>Kullanƒ±cƒ±</th><th>Not</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card top5">
      <h3>ƒ∞lk 5</h3>
      <div id="top5"></div>
    </div>
  </div>
</div>

<script>
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return(h^(h>>>16))>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
function shuffleSeed(arr,seedStr){const seed=xmur3(seedStr)();const rand=mulberry32(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}

const todayStr=new Date().toISOString().slice(0,10);
document.getElementById("today").textContent=todayStr;

async function loadData(){
  const [csvAll,csvTop,bans]=await Promise.all([
    fetch("./data/followers.csv").then(r=>r.text()),
    fetch("./data/top1000.csv").then(r=>r.text()),
    fetch("./data/bans.json").then(r=>r.json()).catch(()=>[])
  ]);
  const followers=csvAll.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const top1000=csvTop.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const banSet=new Set((bans||[]).map(s=>s.toLowerCase()));
  const base=followers.filter(u=>!banSet.has(u.toLowerCase()));
  document.getElementById("total").textContent=base.length;
  document.getElementById("activeCount").textContent=top1000.length;
  return{base,top1000};
}

function buildLB(base,top1000){
  const baseLower=new Set(base.map(u=>u.toLowerCase()));
  const fixedTop=top1000.filter(u=>baseLower.has(u.toLowerCase()));
  const fixedLower=new Set(fixedTop.map(u=>u.toLowerCase()));
  const others=base.filter(u=>!fixedLower.has(u.toLowerCase()));
  const shuffledOthers=shuffleSeed(others,"STATIC-SEED");
  const list=fixedTop.concat(shuffledOthers);
  const idx=new Map();list.forEach((u,i)=>idx.set(u.toLowerCase(),i));
  return{list,idx,fixedCount:fixedTop.length};
}

function renderTop5(list){
  const top=list.slice(0,5);
  document.getElementById("top5").innerHTML=top.map((h,i)=>
    <div class="item"><div>${i+1}. ${h}</div><div>${i===0?"üèÜ":i===1?"ü•à":i===2?"ü•â":""}</div></div>).join("");
}

function renderTable(lb,page=1,pageSize=100,fixedCount=1000){
  const start=(page-1)*pageSize;
  const items=lb.list.slice(start,start+pageSize);
  const tb=document.querySelector("#tbl tbody");
  tb.innerHTML="";
  items.forEach((handle,i)=>{
    const rank=start+i+1;
    tb.innerHTML+=<tr><td class="rank">${rank}</td><td>@${handle}</td><td>${rank<=fixedCount?'<span class="note-chip">√ñncelik</span>':""}</td></tr>;
  });
}

function showYou(username,lb){
  const u=(username||"").replace(/^@/,"");
  const you=document.getElementById("youCard");
  const title=document.getElementById("youTitle");
  const neigh=document.getElementById("youNeighbors");
  if(!u){you.classList.remove("show");return;}
  const i=lb.idx.get(u.toLowerCase());
  if(i==null){you.classList.add("show");title.textContent="@"+u+" bulunamadƒ±";neigh.textContent="";return;}
  const rank=i+1,total=lb.list.length,pct=((rank/total)*100).toFixed(2);
  title.innerHTML=@${u} <span class="green">#${rank} (top %${pct})</span>;
  const from=Math.max(0,i-3),to=Math.min(total,i+4);
  neigh.textContent=lb.list.slice(from,to).map((x,j)=>${from+j+1}. @${x}).join(" ‚Ä¢ ");
  you.classList.add("show");
}

let LB=null;
(async function(){
  const data=await loadData();
  LB=buildLB(data.base,data.top1000);
  for(let i=1;i<=Math.ceil(LB.list.length/100);i++){
    const opt=document.createElement("option");opt.value=i;opt.textContent=i;
    document.getElementById("page").append(opt);
  }
  renderTop5(LB.list);
  renderTable(LB,1,100,data.top1000.length);
  document.getElementById("btnPage").onclick=()=>{const p=parseInt(document.getElementById("page").value)||1;renderTable(LB,p,100,data.top1000.length)};
  document.getElementById("btnFind").onclick=()=>{showYou(document.getElementById("search").value,LB)};
})();
</script>
</body>
</html>
