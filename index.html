<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bugünkü Sıran</title>
  <style>
    :root{
      --bg:#0b0b12; --card:#151525; --line:#282846; --text:#e8e8f1; --mut:#9aa0b4;
      --chip:#1d1d2d; --chipbd:#32324a; --accent:#7c5cff; --accent2:#8f7cff;
      --row:#111122; --row2:#0e0e19; --tag:#2a2a4a;
      --gold:#FFD166; --silver:#C0C0C0; --bronze:#CD7F32;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(11,11,18,.85);backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    h1{font-size:20px;margin:0 10px 0 0}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--chipbd);
      color:#cfd3e6;border-radius:999px;padding:6px 10px;font-size:13px}
    input,select,button{background:#10101a;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:9px 12px}
    input:focus,select:focus,button:focus{outline:2px solid #3a3a72;outline-offset:1px}
    button{cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent2));border:none}
    main{max-width:1100px;margin:14px auto;padding:0 18px;display:grid;grid-template-columns:1.6fr .9fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px}
    .card .head{padding:14px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .card .body{padding:14px}
    .mut{color:var(--mut)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
    th{text-align:left;color:var(--mut);font-weight:600}
    tr:nth-child(even){background:var(--row)}
    tr:nth-child(odd){background:var(--row2)}
    .tag{background:var(--tag);border:1px solid var(--line);border-radius:999px;color:#c7cce6;padding:3px 8px;font-size:12px}
    .rank{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#121228;
          border:1px solid var(--line);font-weight:700}
    .top5-row{display:flex;align-items:center;gap:10px;background:#101022;border:1px solid var(--line);
      padding:10px;border-radius:12px}
    .cup{width:20px;height:20px;opacity:.95}
    .cup.gold{color:var(--gold)} .cup.silver{color:var(--silver)} .cup.bronze{color:var(--bronze)}
    .you{background:#101020;border:1px dashed var(--line);}
    .you strong{font-weight:700}
    .footer{padding:14px 18px;color:var(--mut);text-align:center}
    .userCell{display:flex;align-items:center;gap:10px}
    .avatar{width:26px;height:26px;border-radius:50%;border:1px solid var(--line);object-fit:cover;background:#0f0f1b}
    @media (max-width:920px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>Bugünkü Sıran</h1>

      <span class="chip">Tarih
        <input id="day" type="date" min="2025-08-22" style="background:#0f0f1c;border:none;color:#fff">
      </span>

      <span class="chip">Toplam <strong id="total">0</strong> kişi</span>
      <span class="chip">Öncelik <strong id="activeCount">1000</strong></span>

      <div class="row" style="margin-left:auto">
        <input id="search" placeholder="@kullanıcı bul" />
        <button id="btnFind">Sıramı Göster</button>
      </div>
    </div>
  </header>

  <main>
    <!-- LİSTE -->
    <section class="card">
      <div class="head row">
        <strong>Top 100</strong>
        <span class="mut">İlk 1000 CSV’den sabit; kalanlar seçilen güne göre deterministik karışır.</span>
        <div class="row" style="margin-left:auto">
          <label class="mut">Sayfa</label>
          <select id="page"></select>
          <button id="btnPage" style="padding:9px 12px;background:#1b1b2e;border:1px solid var(--line)">Görüntüle</button>
        </div>
      </div>
      <div class="body">
        <table id="tbl">
          <thead>
            <tr><th>#</th><th>Kullanıcı</th><th class="mut">Not</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- TOP5 -->
    <aside class="card">
      <div class="head"><strong>İlk 5</strong></div>
      <div class="body" id="top5"></div>

      <div class="body card you" id="youCard" style="display:none;margin: 0 14px 14px;border-radius:12px">
        <strong id="youTitle"></strong>
        <div class="mut" id="youNeighbors" style="margin-top:8px"></div>
      </div>
    </aside>
  </main>

  <div class="footer">© 2025</div>

<script>
/*** PRNG (xmur3 + mulberry32) ***/
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^(h>>>16))>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function shuffleSeed(arr, seedStr){
  const seed = xmur3(seedStr)();
  const rand = mulberry32(seed);
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(rand()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
const fmtDate = d => d.toISOString().slice(0,10);
const today = new Date();
const todayStr = fmtDate(today);
document.getElementById("day").value = todayStr;
document.getElementById("day").setAttribute("max", todayStr);

/*** STATE ***/
const STATE = { base:[], top:[], LB:null, pageSize:100 };

/*** DATA LOAD ***/
async function loadData(){
  const v = todayStr; // cache-buster
  const [csvAll, csvTop, bans] = await Promise.all([
    fetch("./data/followers.csv?v="+v).then(r=>r.text()),
    fetch("./data/top1000.csv?v="+v).then(r=>r.text()),
    fetch("./data/bans.json?v="+v).then(r=>r.ok?r.json():[])
  ]);
  const banSet = new Set((bans||[]).map(s=>String(s).trim().replace(/^@/,"").toLowerCase()));

  const followers = csvAll.split(/\r?\n/)
    .map(s=>s.trim().replace(/^@/,""))
    .filter(Boolean)
    .filter(u=>!banSet.has(u.toLowerCase()));

  const topRaw = csvTop.split(/\r?\n/)
    .map(s=>s.trim().replace(/^@/,""))
    .filter(Boolean)
    .filter(u=>!banSet.has(u.toLowerCase())); // banlıysa ayıklıyoruz ama SIRA KORUNUR

  document.getElementById("total").textContent = followers.length;
  document.getElementById("activeCount").textContent = topRaw.length;

  STATE.base = followers;
  STATE.top  = topRaw;
}

/*** BUILD: top1000 sabit, diğerleri günlük deterministik ***/
function buildDaily(base, topRaw, dateStr){
  // top: CSV’deki sırayla, doğrudan
  const top = Array.from(new Set(topRaw.map(u=>u.toLowerCase())))
                 .map(lc => topRaw.find(x=>x.toLowerCase()===lc)); // orijinal sırayı muhafaza

  // tail: base’ten top’ta olmayanlar
  const topSet = new Set(top.map(u=>u.toLowerCase()));
  const tail   = base.filter(u=>!topSet.has(u.toLowerCase()));

  const mixed  = top.concat(shuffleSeed(tail,"DAY-"+dateStr)); // deterministik shuffle
  const idx    = new Map(); mixed.forEach((u,i)=>idx.set(u.toLowerCase(),i));

  return { list:mixed, idx, topLen:top.length };
}

/*** RENDER TOP5 ***/
function cupSVG(cls){ return `
<svg class="cup ${cls}" viewBox="0 0 24 24" fill="currentColor">
<path d="M8 3h8v3h4v3c0 2.8-2 5-6 5H10c-4 0-6-2.2-6-5V6h4V3zm8 10v2H8v-2c1.3.7 2.6 1 4 1s2.7-.3 4-1zm-8 4h8v2c0 1.7-1.3 3-3 3H9c-1.7 0-3-1.3-3-3v-2z"/>
</svg>`; }
function renderTop5(list){
  const box = document.getElementById("top5");
  box.innerHTML="";
  for(let i=0;i<5 && i<list.length;i++){
    const u=list[i]; const icon = i===0?cupSVG("gold") : i===1?cupSVG("silver") : i===2?cupSVG("bronze") : "";
    box.insertAdjacentHTML("beforeend",
      `<div class="top5-row" style="margin-bottom:10px">
         <div class="rank">${i+1}</div>
         <div style="flex:1 1 auto" class="userCell">
           <img class="avatar" referrerpolicy="no-referrer" loading="lazy"
                src="https://unavatar.io/instagram/${encodeURIComponent(u)}"
                onerror="this.style.display='none'">
           <a href="https://www.instagram.com/${u}" target="_blank" rel="noreferrer">@${u}</a>
         </div>
         ${icon}
       </div>`);
  }
}

/*** RENDER TABLE (paged) ***/
function renderTable(list, page=1, size=100, topLen=1000){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML="";
  const start=(page-1)*size, end=Math.min(list.length,start+size);
  for(let i=start;i<end;i++){
    const u=list[i]; const rank=i+1;
    const tag = rank<=topLen ? `<span class="tag">Öncelik</span>` : "";
    tb.insertAdjacentHTML("beforeend",
      `<tr>
        <td>${rank}</td>
        <td>
          <div class="userCell">
            <img class="avatar" referrerpolicy="no-referrer" loading="lazy"
                 src="https://unavatar.io/instagram/${encodeURIComponent(u)}"
                 onerror="this.style.display='none'">
            <a href="https://www.instagram.com/${u}" target="_blank" rel="noreferrer">@${u}</a>
          </div>
        </td>
        <td>${tag}</td>
      </tr>`);
  }
}

/*** PAGE OPTIONS ***/
function fillPages(total,size){
  const sel = document.getElementById("page");
  sel.innerHTML="";
  const pages = Math.max(1, Math.ceil(total/size));
  for(let p=1;p<=pages;p++){
    const opt=document.createElement("option");
    opt.value=p; opt.textContent=p;
    sel.appendChild(opt);
  }
}

/*** YOU (search result) ***/
function showYou(username, LB){
  const youCard = document.getElementById("youCard");
  const title   = document.getElementById("youTitle");
  const neigh   = document.getElementById("youNeighbors");
  const u = (username||"").trim().replace(/^@/,"");
  if(!u){ youCard.style.display="none"; return; }
  const i = LB.idx.get(u.toLowerCase());
  if(i==null){
    youCard.style.display="block";
    title.textContent = `@${u} bugün listede bulunamadı.`;
    neigh.textContent = ``;
    return;
  }
  const rank=i+1, total=LB.list.length, pct=((rank/total)*100).toFixed(2);
  const from=Math.max(0,i-3), to=Math.min(total,i+4);
  const neighbors=LB.list.slice(from,to).map((x,j)=> `${from+j+1}. @${x}`).join(" • ");
  youCard.style.display="block";
  title.innerHTML = `<strong>@${u}</strong> → #${rank} (ilk %${pct})`;
  neigh.textContent = neighbors;
}

/*** INIT ***/
(async function(){
  try{
    await loadData();
    STATE.LB = buildDaily(STATE.base, STATE.top, todayStr);
    renderTop5(STATE.LB.list);
    fillPages(STATE.LB.list.length, STATE.pageSize);
    renderTable(STATE.LB.list, 1, STATE.pageSize, STATE.LB.topLen);
  }catch(e){
    alert("Veri yüklenemedi."); console.error(e);
  }
})();

/*** EVENTS ***/
document.getElementById("btnPage").onclick = ()=>{
  const p = parseInt(document.getElementById("page").value,10)||1;
  renderTable(STATE.LB.list, p, STATE.pageSize, STATE.LB.topLen);
};
document.getElementById("btnFind").onclick = ()=>{
  const v = document.getElementById("search").value;
  showYou(v, STATE.LB);
};
document.getElementById("day").addEventListener("change",(e)=>{
  const d = e.target.value || todayStr;
  STATE.LB = buildDaily(STATE.base, STATE.top, d);
  renderTop5(STATE.LB.list);
  fillPages(STATE.LB.list.length, STATE.pageSize);
  document.getElementById("page").value = "1";
  renderTable(STATE.LB.list, 1, STATE.pageSize, STATE.LB.topLen);
  const v = document.getElementById("search").value;
  if(v) showYou(v, STATE.LB);
});
</script>
</body>
</html>
