<script>
/* PRNG + shuffle (deterministik) */
function xmur3(s){let h=1779033703^s.length;for(let i=0;i<s.length;i++){h=Math.imul(h^s.charCodeAt(i),3432918353);h=h<<13|h>>>19}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^(h>>>16))>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function shuffleSeed(arr,seedStr){const seed=xmur3(seedStr)();const rand=mulberry32(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

const todayStr=new Date().toISOString().slice(0,10);
document.getElementById("today").textContent=todayStr;
const v=todayStr; // cache-buster

/* Veri yükleme: followers + top1000 + bans */
async function loadData(){
  const [csvAll,csvTop,bans] = await Promise.all([
    fetch(`/data/followers.csv?v=${v}`).then(r=>{if(!r.ok)throw new Error('followers.csv '+r.status);return r.text()}),
    fetch(`/data/top1000.csv?v=${v}`).then(r=>r.ok?r.text():"").catch(()=>""), // opsiyonel
    fetch(`/data/bans.json?v=${v}`).then(r=>r.ok?r.json():[]).catch(()=>[])
  ]).catch(err=>{
    console.error('DATA LOAD ERROR:', err);
    alert('Veri yüklenemedi: '+err.message);
    return ["","",[]];
  });

  const followers = (csvAll||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const banSet = new Set((bans||[]).map(s=>s.toLowerCase()));
  const base = followers.filter(u=>!banSet.has((u||"").toLowerCase()));

  // top1000 dosyası varsa ÖNCELİKLE onu uygula (sırayı koru)
  const rawTop = (csvTop||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const topSet = new Set(rawTop.map(s=>s.toLowerCase()));

  document.getElementById("total").textContent = base.length;
  document.getElementById("activeCount").textContent = rawTop.length || 0; // rozette sayıyı gösterelim

  return { base, rawTop, topSet };
}

/* Günlük sıralama: top1000 + karışık diğerleri */
function buildDailyLeaderboard(base, rawTop, topSet, dateStr){
  // 1) top listesinde olup gerçek listede de bulunanları sırayı BOZMADAN al
  const top = rawTop.filter(u => topSet.has(u.toLowerCase()) && base.some(b=>b.toLowerCase()===u.toLowerCase()));

  // 2) diğerleri (top’ta olmayanlar)
  const baseSet = new Set(base.map(u=>u.toLowerCase()));
  const topLower = new Set(top.map(u=>u.toLowerCase()));
  const others = base.filter(u => !topLower.has(u.toLowerCase()) && baseSet.has(u.toLowerCase()));

  // 3) günü seed alarak diğerlerini karıştır ve finali oluştur
  const shuffledOthers = shuffleSeed(others, "DAY-"+dateStr);
  const list = top.concat(shuffledOthers);

  // index map
  const idx = new Map(); list.forEach((u,i)=>idx.set(u.toLowerCase(), i));
  return { list, idx };
}

/* UI */
function renderTable(list, page=1, pageSize=100){
  const start=(page-1)*pageSize, items=list.slice(start,start+pageSize);
  const tb=document.querySelector("#tbl tbody"); tb.innerHTML="";
  for(let i=0;i<items.length;i++){
    const rank=start+i+1;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${rank}</td><td>@${items[i]}</td><td class="muted">${rank<=1000?"Öncelikli liste":""}</td>`;
    tb.appendChild(tr);
  }
}
function showYou(username, lb){
  const u=(username||"").trim().replace(/^@/,"");
  const youCard=document.getElementById("youCard");
  const title=document.getElementById("youTitle");
  const neigh=document.getElementById("youNeighbors");
  if(!u){youCard.style.display="none";return}
  const i=lb.idx.get(u.toLowerCase());
  if(i==null){youCard.style.display="block";title.textContent=`@${u} bugün listede bulunamadı.`;neigh.textContent="";return}
  const rank=i+1, total=lb.list.length, pct=((rank/total)*100).toFixed(2);
  const from=Math.max(0,i-3), to=Math.min(total,i+4);
  const neighbors=lb.list.slice(from,to).map((x,j)=>`${from+j+1}. @${x}`).join(" • ");
  youCard.style.display="block";
  title.textContent=`@${u} → #${rank} (top %${pct})`;
  neigh.textContent=neighbors;
}

/* Başlat */
let LB=null;
(async function(){
  const data = await loadData();
  LB = buildDailyLeaderboard(data.base, data.rawTop, data.topSet, todayStr);
  renderTable(LB.list,1,100);
})();
document.getElementById("btnPage").onclick=()=>{const p=parseInt(document.getElementById("page").value,10)||1;renderTable(LB.list,p,100)};
document.getElementById("btnFind").onclick=()=>{const v=document.getElementById("search").value;showYou(v,LB)};
</script>
